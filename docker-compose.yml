# Browser Coder - Production Ready Docker Compose
# 
# ONE COMMAND DEPLOYMENT:
#   docker compose up -d
#
# This automatically:
# - Builds and runs the application
# - Starts nginx load balancer  
# - Enables auto-scaling (1-8 API instances based on load)
# - Handles 10,000+ concurrent users
# - SECURITY: Sandboxed code execution
#
# Access: http://localhost

services:
  # ============================================
  # NGINX - Load Balancer & Static Files
  # ============================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      api:
        condition: service_healthy
    restart: always
    networks:
      - internal
      - default
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # API - Smart Auto-Scaling Server (SANDBOXED)
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.production
    expose:
      - "3001"
    volumes:
      - ./security/reports:/app/security/reports:rw
    environment:
      - NODE_ENV=production
      - PORT=3001
      - RATE_LIMIT_MAX=200
      - RUN_TIMEOUT_MS=10000
      - MAX_SCALE=${MAX_SCALE:-8}
    # SECURITY: Container-level sandboxing
    security_opt:
      - no-new-privileges:true
    read_only: false  # Needed for temp files during code execution
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /app/sandbox:size=50M,mode=0700,uid=1001,gid=1001
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
    # SECURITY: Network isolation - no external network access
    networks:
      - internal
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: always
    deploy:
      mode: replicated
      replicas: ${INITIAL_REPLICAS:-2}
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
        # SECURITY: Limit PIDs to prevent fork bombs
      
  # ============================================
  # AUTOSCALER - Monitors load & scales API
  # ============================================
  autoscaler:
    build:
      context: .
      dockerfile: Dockerfile.autoscaler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - SERVICE_NAME=browser-coder-api
      - MIN_REPLICAS=${MIN_REPLICAS:-1}
      - MAX_REPLICAS=${MAX_SCALE:-8}
      - SCALE_UP_CPU_THRESHOLD=70
      - SCALE_DOWN_CPU_THRESHOLD=30
      - SCALE_UP_QUEUE_THRESHOLD=50
      - CHECK_INTERVAL_SECONDS=10
      - COOLDOWN_SECONDS=30
    depends_on:
      - api
    restart: always
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 64M

  # ============================================
  # SECURITY TESTS - Runs once on startup
  # ============================================
  security-tests:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./security:/app/security:rw
      - ./package.json:/app/package.json:ro
    environment:
      - NODE_ENV=production
    command: ["node", "security/run.mjs", "--server=http://api:3001"]
    depends_on:
      api:
        condition: service_healthy
    networks:
      - internal
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 256M

networks:
  internal:
    driver: bridge
  default:
    driver: bridge
