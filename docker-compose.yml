# Browser Coder - Production Ready Docker Compose
# 
# ONE COMMAND DEPLOYMENT:
#   docker compose up -d
#
# This automatically:
# - Builds and runs the application
# - Starts nginx load balancer  
# - Enables auto-scaling (1-8 API instances based on load)
# - Handles 10,000+ concurrent users
#
# Access: http://localhost

services:
  # ============================================
  # NGINX - Load Balancer & Static Files
  # ============================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./dist:/usr/share/nginx/html:ro
    depends_on:
      api:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # API - Smart Auto-Scaling Server
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.production
    expose:
      - "3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - RATE_LIMIT_MAX=200
      - RUN_TIMEOUT_MS=10000
      - MAX_SCALE=${MAX_SCALE:-8}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: always
    deploy:
      mode: replicated
      replicas: ${INITIAL_REPLICAS:-2}
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================
  # AUTOSCALER - Monitors load & scales API
  # ============================================
  autoscaler:
    build:
      context: .
      dockerfile: Dockerfile.autoscaler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - SERVICE_NAME=browser_coder-api
      - MIN_REPLICAS=${MIN_REPLICAS:-1}
      - MAX_REPLICAS=${MAX_SCALE:-8}
      - SCALE_UP_CPU_THRESHOLD=70
      - SCALE_DOWN_CPU_THRESHOLD=30
      - SCALE_UP_QUEUE_THRESHOLD=50
      - CHECK_INTERVAL_SECONDS=10
      - COOLDOWN_SECONDS=30
    depends_on:
      - api
    restart: always
    deploy:
      resources:
        limits:
          memory: 64M
