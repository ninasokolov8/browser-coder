# Browser Coder - Production Docker Compose for DigitalOcean
# 
# This file uses pre-built images from GitHub Container Registry
# for faster deployments on the production server.
#
# Usage:
#   docker compose -f docker-compose.prod.yml up -d

services:
  # ============================================
  # NGINX - Load Balancer & Static Files
  # ============================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./security/reports:/usr/share/nginx/reports:ro
    depends_on:
      api:
        condition: service_healthy
    restart: always
    networks:
      - internal
      - default
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # API - Uses pre-built image from GHCR
  # ============================================
  api:
    image: ghcr.io/ninasokolov8/browser-coder:latest
    build:
      context: .
      dockerfile: Dockerfile.production
    expose:
      - "3001"
    volumes:
      - ./security/reports:/app/security/reports:rw
    environment:
      - NODE_ENV=production
      - PORT=3001
      - RATE_LIMIT_MAX=200
      - RUN_TIMEOUT_MS=10000
      - MAX_SCALE=${MAX_SCALE:-8}
    # SECURITY: Container-level sandboxing
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: always
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: ${REPLICAS:-2}
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================
  # Autoscaler (Optional - for high traffic)
  # ============================================
  autoscaler:
    build:
      context: .
      dockerfile: Dockerfile.autoscaler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - SERVICE_NAME=browser_coder-api
      - MIN_REPLICAS=${MIN_REPLICAS:-1}
      - MAX_REPLICAS=${MAX_SCALE:-8}
      - SCALE_UP_CPU_THRESHOLD=70
      - SCALE_DOWN_CPU_THRESHOLD=30
      - CHECK_INTERVAL_SECONDS=10
      - COOLDOWN_SECONDS=30
    depends_on:
      - api
    restart: always
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 64M
    profiles:
      - autoscale  # Only runs with: docker compose --profile autoscale up

networks:
  internal:
    driver: bridge
  default:
    driver: bridge
